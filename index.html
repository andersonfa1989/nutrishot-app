
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>NutriShot Elements</title>

  <!-- AdSense (Web) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6941311170472131" crossorigin="anonymous"></script>

  <style>
    :root { 
      --primary: #2ab573; 
      --blue-action: #2490eb; 
      --bg: #f9fafb; 
      --water: #3498db;
    }
    body { 
      margin: 0; 
      font-family: 'Segoe UI', Roboto, sans-serif; 
      background: var(--bg); 
      color: #333;
      padding-bottom: 0;
      overflow-x: hidden; 
    }

    /* ================= Sidebar ================ */
    .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: #fff; z-index: 10000;
      transition: .3s cubic-bezier(.4,0,.2,1); box-shadow: 2px 0 15px rgba(0,0,0,.1); display:flex; flex-direction:column; }
    .sidebar.active { left: 0; }
    .sidebar-header { padding: 40px 20px 20px; background: linear-gradient(135deg,var(--blue-action),var(--primary)); color:#fff; }
    .sidebar-menu { padding:20px 0; flex-grow:1; }
    .menu-item { padding:15px 25px; display:flex; align-items:center; gap:15px; cursor:pointer; font-weight:500; color:#444; }
    .menu-item:hover { background:#f0f7f4; color:var(--primary); }
    .sidebar-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; z-index:9999; backdrop-filter:blur(2px); }
    .sidebar-overlay.active { display:block; }

    /* ================= UI ================ */
    .texto-logo { font-size:24px; font-weight:800;
      background: linear-gradient(to right,#2490eb,#2ab573,#f39c12);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      margin:0 0 20px; }
    .input-nutri { width:85%; padding:15px; margin:10px 0; border:1px solid #ddd; border-radius:12px; font-size:16px; }
    .input-metade { width:40%; }
    .btn-azul { width:calc(100% - 40px); background:var(--blue-action); color:#fff;
      border:none; padding:18px; border-radius:30px; margin:10px 20px; font-size:18px; font-weight:bold; cursor:pointer; }
    .card { background:#fff; border-radius:20px; padding:20px; margin:15px 20px; border:1px solid #eee; box-shadow:0 4px 15px rgba(0,0,0,.02); }
    .card-fogo { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; border:none; display:flex; justify-content:space-between; }

    .fab { position:fixed; bottom:30px; right:20px; width:65px; height:65px; background:#000;
      color:#fff; border-radius:50%; font-size:30px; border:none; box-shadow:0 5px 20px rgba(0,0,0,.3); z-index:99; }

    /* =============== Banner Web INLINE =============== */
    .ad-footer { 
      width:100%; background:#fff; border-top:1px solid #eee;
      height:65px; display:flex; flex-direction:column; align-items:center; justify-content:center;
      margin-top:10px;
    }
    .adbox { width:320px; height:50px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .adbox ins.adsbygoogle { width:320px !important; height:50px !important; display:inline-block !important; }
    .ad-footer small { font-size:9px; color:#aaa; margin-top:2px; text-transform:uppercase; }

    /* ===== Fallback overlay ===== */
    .ads-overlay { display:none; position:fixed; inset:0; background:#000; color:#fff;
      z-index:99999; display:flex; align-items:center; justify-content:center; flex-direction:column; }
    .bar-container { width:70%; height:8px; background:#333; border-radius:10px; margin-top:25px; }
    #bar-progress { width:0%; height:100%; background:#2ab573; transition:width .1s linear; }
  </style>
</head>
<body>

  <div id="ads-overlay" class="ads-overlay">
    <div id="ad-text" style="font-size:18px;font-weight:bold;">Analisando...</div>
    <div class="bar-container"><div id="bar-progress"></div></div>
  </div>

  <div id="app"></div>

  <!-- ===== Banner Web (inline no final da p√°gina) ===== -->
  <div id="ad-footer-web" class="ad-footer">
    <div class="adbox">
      <ins class="adsbygoogle"
           style="display:inline-block;width:320px;height:50px"
           data-ad-client="ca-pub-6941311170472131"
           data-ad-slot="2257554053"
           data-full-width-responsive="false"></ins>
    </div>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    <small>Publicidade</small>
  </div>

<script>
/* =======================================================================================
      üîµ BLOCO 1 ‚Äî ESTADO, IMC, IA, PLANO ALIMENTAR, RESET DI√ÅRIO
======================================================================================= */

const isNative = !!(window?.Capacitor?.isNativePlatform?.() && window.Capacitor.isNativePlatform());

/* === Seus IDs AdMob preenchidos === */
const ADMOB = {
  APP_ID: "ca-app-pub-6941311170472131~1202658535",
  BANNER_ID: "ca-app-pub-6941311170472131/2257554053",
  INTERSTITIAL_ID: "ca-app-pub-6941311170472131/2273031775",
  REWARDED_ID: "ca-app-pub-6941311170472131/4221550021"
};

/* === Estado === */
let estado = JSON.parse(localStorage.getItem("nutrishot_v5")) || {
  logado: false, tela: "cadastro", nomeUsuario: "Usu√°rio", objetivo: "perda",
  peso: 70, altura:170, imc: 24.2, classification: "Normal",
  calorias:0, prot:0, carb:0, gord:0, aguaAtual:0,
  historico:[], sequencia:1, ultimoAcesso: new Date().toDateString(),
  tempRefeicao:"Almo√ßo", fotoSelecionada:null, ultimoResultado:null,
  ultimoReset:null
};

function salvar(){ localStorage.setItem("nutrishot_v5", JSON.stringify(estado)); }
function navegar(t){ estado.tela = t; salvar(); render(); window.scrollTo(0,0); }

/* ========== IA BACKEND ========== */
async function analisarRefeicaoPorIA(){
  try{
    const r = await fetch("YOUR_BACKEND_URL/analyze-food",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ imageBase64: estado.fotoSelecionada })
    });
    if(!r.ok) throw new Error();
    return await r.json();
  }catch(e){
    /* fallback */
    const cal = Math.floor(Math.random()*200+350);
    return { kcal:cal, prot:cal*0.05|0, carb:cal*0.12|0, gord:cal*0.03|0 };
  }
}

/* ========= Plano Alimentar ========= */
function getImcFaixa(imc){
  if(imc<18.5) return "baixo";
  if(imc<25) return "normal";
  if(imc<30) return "sobrepeso";
  if(imc<35) return "obesidade1";
  if(imc<40) return "obesidade2";
  return "obesidade3";
}

function calcularAlvoCalorico(objetivo, imc, peso){
  const faixa = getImcFaixa(imc);
  let kcalKg;
  if(objetivo==="perda"){
    if(faixa==="obesidade2"||faixa==="obesidade3") kcalKg=22;
    else if(faixa==="sobrepeso"||faixa==="obesidade1") kcalKg=24;
    else kcalKg=26;
  } else {
    if(faixa==="baixo") kcalKg=38;
    else if(faixa==="normal") kcalKg=34;
    else kcalKg=30;
  }
  return Math.max(1200, Math.min(4200, Math.round(kcalKg*peso)));
}

function calcularMacros(objetivo, imc, peso, kcal){
  const faixa = getImcFaixa(imc);
  let protKg, gordKg;
  if(objetivo==="perda"){
    protKg = (faixa==="sobrepeso"||faixa.includes("obesidade")) ? 2.0 : 1.6;
    gordKg = 0.8;
  } else {
    protKg = 1.8; gordKg = 1.0;
  }
  const prot = Math.round(protKg*peso);
  const gord = Math.round(gordKg*peso);
  const carb = Math.max(0, Math.round((kcal - (prot*4 + gord*9)) / 4));
  return { prot, carb, gord };
}

/* ========= AdMob (nativo) ‚Äî Banner s√≥ na tela PROGRESSO ========= */
let admobReady = false;
let nativeBannerShown = false;

async function initAdMobIfAvailable() {
  try{
    const CapAdMob = window?.Capacitor?.Plugins?.AdMob;
    if(CapAdMob?.initialize){
      await CapAdMob.initialize({ requestTrackingAuthorization:true, initializeForTesting:false });
      await CapAdMob.prepareInterstitial({ adId:ADMOB.INTERSTITIAL_ID });
      await CapAdMob.prepareRewardVideoAd({ adId:ADMOB.REWARDED_ID });
      admobReady = true;
    }
  }catch(e){
    console.warn("Erro init AdMob:",e);
  }
}

async function showNativeBanner(){
  if(!isNative||!admobReady||nativeBannerShown) return;

  const webBanner = document.getElementById("ad-footer-web");
  if(webBanner) webBanner.style.display = "none";

  const CapAdMob = window?.Capacitor?.Plugins?.AdMob;
  try{
    await CapAdMob.showBanner({
      adId: ADMOB.BANNER_ID,
      adSize: "BANNER",
      position: "BOTTOM_CENTER"
    });
    nativeBannerShown = true;
  }catch(e){
    console.warn("Falha showBanner:",e);
  }
}

async function hideNativeBanner(){
  if(!isNative||!nativeBannerShown) return;

  const CapAdMob = window?.Capacitor?.Plugins?.AdMob;
  try{ await CapAdMob.hideBanner(); }catch{}
  nativeBannerShown = false;

  const webBanner = document.getElementById("ad-footer-web");
  if(webBanner) webBanner.style.display = "";
}

async function syncBannerWithView(){
  if(!isNative || !admobReady){
    const web = document.getElementById("ad-footer-web");
    if(web) web.style.display="";
    return;
  }
  if(estado.tela==="progresso") await showNativeBanner();
  else await hideNativeBanner();
}

if(isNative){
  document.addEventListener("deviceready", initAdMobIfAvailable);
  window.addEventListener("load", initAdMobIfAvailable);
}

/* =======================================================================================
      üîµ BLOCO 2 ‚Äî RENDERIZA√á√ÉO DAS TELAS
======================================================================================= */

function render(){
  const root = document.getElementById("app");

  /* ====================== LOGIN ====================== */
  if(!estado.logado){
    const cad = estado.tela==="cadastro";
    root.innerHTML = `
      <div style="padding:50px 20px; text-align:center;">
        <h1 class="texto-logo">NutriShot Elements</h1>
        ${cad?`
          <input type="text" id="nome-f" class="input-nutri" placeholder="Nome">
          <div style="display:flex; gap:10px; justify-content:center;">
            <input type="number" id="peso-f" class="input-nutri input-metade" placeholder="Peso (kg)">
            <input type="number" id="altura-f" class="input-nutri input-metade" placeholder="Altura (cm)">
          </div>`:''}
        <input type="email" id="email-f" class="input-nutri" placeholder="E-mail">
        <input type="password" id="pass-f" class="input-nutri" placeholder="Senha">
        <button class="btn-azul" onclick="validarEEntrar()">${cad?'CRIAR MINHA CONTA':'ENTRAR NO APP'}</button>
        <p class="footer-link" onclick="navegar('${cad?'login':'cadastro'}')">
          ${cad?'J√° tem uma conta? <span>Entrar</span>':'Novo por aqui? <span>Criar Conta</span>'}
        </p>
      </div>
    `;
    syncBannerWithView();
    return;
  }

  /* ====================== HOME ====================== */
  if(estado.tela==="home"){
    const perc = Math.min((estado.calorias/2577)*100,100);
    const metaAgua = Math.round(estado.peso*35);
    const percAgua = Math.min((estado.aguaAtual/metaAgua)*100,100);

    root.innerHTML = `
      <div style="padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div onclick="toggleMenu()" style="font-size:28px; cursor:pointer;">‚ò∞</div>
        <b>${estado.nomeUsuario}</b>
      </div>

      <div class="card card-fogo">
        <div>
          <small>Sequ√™ncia ativa</small>
          <div style="font-size:26px; font-weight:bold;">${estado.sequencia} dias üî•</div>
        </div>
        <div class="imc-info" onclick="editarMedidas()">
          <div class="imc-label">IMC ‚úé</div>
          <div style="font-size:22px; font-weight:bold;">${estado.imc}</div>
          <span class="imc-status">${estado.classification}</span>
        </div>
      </div>

      <div class="card">
        <b>Hidrata√ß√£o di√°ria</b>
        <small>${estado.aguaAtual}ml / ${metaAgua}ml</small>
        <div class="progress-container">
          <div class="progress-bar water" style="width:${percAgua}%"></div>
        </div>
        <button class="btn-water" onclick="beberAgua()">+250ml</button>
      </div>

      <div class="card">
        <b>Consumo de Calorias</b>
        <div style="font-size:26px;font-weight:bold;">${estado.calorias}
          <span style="font-size:14px;color:#ccc;">/ 2577 kcal</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar" style="width:${perc}%"></div>
        </div>
      </div>

      <button class="fab" onclick="navegar('add_refeicao')">+</button>
    `;
    syncBannerWithView();
    return;
  }

  /* ====================== TELA PLANO ====================== */
  if(estado.tela==="plano"){
    const plano = gerarPlanoAuto();
    root.innerHTML=`
      <div style="padding:20px;">
        <div onclick="navegar('home')" style="cursor:pointer;color:var(--blue-action)">‚Üê Voltar</div>
        <h2>Plano alimentar</h2>

        <div class="card" style="border-left:4px solid var(--primary)">
          <b>Meta di√°ria</b>
          <div><b>${plano.kcal} kcal</b> ‚Äî Prot ${plano.prot}g ‚Ä¢ Carb ${plano.carb}g ‚Ä¢ Gord ${plano.gord}g</div>
        </div>

        ${plano.refeicoes.map(r=>`
          <div class="card">
            <b>${r.nome} ‚Ä¢ ${r.kcal} kcal</b>
            <div>P:${r.prot}g ‚Ä¢ C:${r.carb}g ‚Ä¢ G:${r.gord}g</div>
            <div style="margin-top:8px">${r.sugestao}</div>
          </div>
        `).join("")}

        <button class="btn-principal" onclick="gerarPlanoWhatsApp()">Compartilhar no WhatsApp</button>
      </div>
    `;
    syncBannerWithView();
    return;
  }

  /* ====================== TELA PROGRESSO ‚Äî banner nativo aqui ====================== */
  if(estado.tela==="progresso"){
    const dias = calcularProgressoSemanal();
    const nomes = ["S","T","Q","Q","S","S","D"];
    root.innerHTML=`
      <div style="padding:20px;">
        <div onclick="navegar('home')" style="cursor:pointer;color:var(--blue-action)">‚Üê Voltar</div>
        <h2>Progresso semanal</h2>

        <div class="card">
          <div class="week-bars">
            ${dias.map((p,i)=>`
              <div class="week-col">
                <div class="week-bar">
                  <div class="week-fill" style="height:${p}%"></div>
                </div>
                <div class="week-day">${nomes[i]}</div>
              </div>
            `).join("")}
          </div>
        </div>
      </div>
    `;
    syncBannerWithView();  // <- MOSTRA o banner nativo aqui
    return;
  }

  /* ====================== CAT√ÅLOGO ====================== */
  if(estado.tela==="catalogo"){
    syncBannerWithView();
    root.innerHTML=`<h2 style="padding:20px;">Cat√°logo</h2>`;
    return;
  }

  /* ====================== ADICIONAR REFEI√á√ÉO ====================== */
  if(estado.tela==="add_refeicao"){
    syncBannerWithView();
    root.innerHTML=`
      <h2 style="padding:20px;">Adicionar refei√ß√£o</h2>
      <button class="btn-principal" onclick="confirmarAnalise()">Analisar foto</button>
    `;
    return;
  }

  /* ====================== RESULTADO ====================== */
  if(estado.tela==="resultado_analise"){
    syncBannerWithView();
    root.innerHTML=`
      <div class="dica-container">
        <h2>Resultado</h2>
        <div class="dica-texto-grande">
          ${estado.ultimoResultado.cal} kcal
        </div>
        <button class="btn-principal" onclick="navegar('home')">Voltar</button>
      </div>
    `;
    return;
  }
}

/* Inicializa√ß√£o */
verificarSequencia();
verificarResetDiario();
render();
</script>

</body>
</html>
